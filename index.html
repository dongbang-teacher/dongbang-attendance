<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>동방고등학교 실시간 출석부</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 5px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .status-connected {
            background: #28a745;
            box-shadow: 0 0 10px #28a745;
        }

        .status-disconnected {
            background: #dc3545;
        }

        .tab-container {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            background: white;
            border-bottom-color: #4a90e2;
            color: #4a90e2;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .form-section h3 {
            color: #343a40;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #4a90e2;
            padding-bottom: 8px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        input[type="date"] {
            position: relative;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }

        /* 주말 입력 방지 스타일 */
        .weekend-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #ffeaa7;
        }

        .date-info {
            margin-top: 5px;
            font-size: 12px;
        }

        .sunday { color: #dc3545; font-weight: bold; }
        .saturday { color: #007bff; font-weight: bold; }
        .weekday { color: #28a745; }

        input[type="date"],
        input[type="text"],
        select {
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        input[readonly] {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .attendance-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .attendance-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .attendance-card:hover {
            border-color: #4a90e2;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .attendance-card h4 {
            color: #343a40;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1em;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
        }

        .radio-option label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(23, 162, 184, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .attendance-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .attendance-list table {
            width: 100%;
            border-collapse: collapse;
        }

        .attendance-list th {
            background: #4a90e2;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .attendance-list td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .attendance-list tr:nth-child(even) {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .status-absent { background: #ffe6e6; color: #dc3545; }
        .status-late { background: #fff3cd; color: #856404; }
        .status-early { background: #d4edda; color: #155724; }
        .status-absence { background: #e2e3e5; color: #383d41; }

        .detail-badge {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            margin-left: 5px;
        }

        .detail-approved { background: #d4edda; color: #155724; }
        .detail-unapproved { background: #f8d7da; color: #721c24; }
        .detail-sick { background: #cce5ff; color: #004085; }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .date-range-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-range-container input[type="date"] {
            flex: 1;
        }

        .date-range-container span {
            color: #6c757d;
            font-weight: 500;
        }

        .search-type-toggle {
            display: flex;
            background: #e9ecef;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 15px;
        }

        .search-type-btn {
            flex: 1;
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-type-btn.active {
            background: #4a90e2;
            color: white;
            box-shadow: 0 2px 4px rgba(74, 144, 226, 0.3);
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .confirm-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .confirm-content h3 {
            color: #dc3545;
            margin-bottom: 15px;
        }

        .confirm-content p {
            margin-bottom: 20px;
            color: #6c757d;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .attendance-types {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .tab-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏫 동방고등학교</h1>
            <p>실시간 출석부 관리 시스템 <span class="status-indicator" id="connectionStatus"></span></p>
        </div>

        <div class="tab-container">
            <button class="tab-button active" onclick="openTab(event, 'input-tab')">📝 출결 입력</button>
            <button class="tab-button" onclick="openTab(event, 'view-tab')">👀 출결 조회</button>
        </div>

        <!-- 출결 입력 탭 -->
        <div id="input-tab" class="tab-content active">
            <div class="form-section">
                <h3>📅 기본 정보</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="inputDate">날짜</label>
                        <input type="date" id="inputDate" required onchange="checkWeekend(this)">
                        <div id="dateInfo" class="date-info"></div>
                        <div id="weekendWarning" class="weekend-warning" style="display: none;">
                            ⚠️ 주말은 등교일이 아닙니다. 평일을 선택해주세요.
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputGrade">학년</label>
                        <select id="inputGrade" required onchange="updateHomeRoomTeacher()">
                            <option value="">선택하세요</option>
                            <option value="1">1학년</option>
                            <option value="2">2학년</option>
                            <option value="3">3학년</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="inputClass">반</label>
                        <select id="inputClass" required onchange="updateHomeRoomTeacher()">
                            <option value="">선택하세요</option>
                            <option value="1">1반</option>
                            <option value="2">2반</option>
                            <option value="3">3반</option>
                            <option value="4">4반</option>
                            <option value="5">5반</option>
                            <option value="6">6반</option>
                            <option value="7">7반</option>
                            <option value="8">8반</option>
                            <option value="9">9반</option>
                            <option value="10">10반</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="inputTeacher">담임교사</label>
                        <input type="text" id="inputTeacher" placeholder="학년과 반을 선택하면 자동 입력됩니다" readonly>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>📋 출결 상태</h3>
                <div class="attendance-types">
                    <div class="attendance-card">
                        <h4>🚫 결석</h4>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="absent-approved" name="attendanceType" value="결석-인정">
                                <label for="absent-approved">인정</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="absent-unapproved" name="attendanceType" value="결석-미인정">
                                <label for="absent-unapproved">미인정</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="absent-sick" name="attendanceType" value="결석-질병">
                                <label for="absent-sick">질병</label>
                            </div>
                        </div>
                    </div>

                    <div class="attendance-card">
                        <h4>⏰ 지각</h4>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="late-approved" name="attendanceType" value="지각-인정">
                                <label for="late-approved">인정</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="late-unapproved" name="attendanceType" value="지각-미인정">
                                <label for="late-unapproved">미인정</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="late-sick" name="attendanceType" value="지각-질병">
                                <label for="late-sick">질병</label>
                            </div>
                        </div>
                    </div>

                    <div class="attendance-card">
                        <h4>🏃 조퇴</h4>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="early-approved" name="attendanceType" value="조퇴-인정">
                                <label for="early-approved">인정</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="early-unapproved" name="attendanceType" value="조퇴-미인정">
                                <label for="early-unapproved">미인정</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="early-sick" name="attendanceType" value="조퇴-질병">
                                <label for="early-sick">질병</label>
                            </div>
                        </div>
                    </div>

                    <div class="attendance-card">
                        <h4>📚 결과</h4>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="absence-approved" name="attendanceType" value="결과-인정">
                                <label for="absence-approved">인정</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="absence-unapproved" name="attendanceType" value="결과-미인정">
                                <label for="absence-unapproved">미인정</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="absence-sick" name="attendanceType" value="결과-질병">
                                <label for="absence-sick">질병</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>👤 학생 정보</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="studentId">학번</label>
                        <input type="text" id="studentId" placeholder="학번을 입력하세요" required>
                    </div>
                    <div class="form-group">
                        <label for="studentName">학생 이름</label>
                        <input type="text" id="studentName" placeholder="학생 이름을 입력하세요" required>
                    </div>
                    <div class="form-group">
                        <label for="studentNote">비고</label>
                        <input type="text" id="studentNote" placeholder="비고사항을 입력하세요 (선택사항)">
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button type="button" class="btn-primary" id="submitBtn" onclick="submitAttendance()">✅ 입력 완료</button>
                <button type="button" class="btn-secondary" onclick="clearForm()">🔄 초기화</button>
            </div>
        </div>

        <!-- 출결 조회 탭 -->
        <div id="view-tab" class="tab-content">
            <div class="form-section">
                <h3>🔍 조회 조건</h3>
                
                <!-- 조회 타입 토글 -->
                <div class="search-type-toggle">
                    <button type="button" class="search-type-btn active" onclick="toggleSearchType('single')">📅 단일 날짜</button>
                    <button type="button" class="search-type-btn" onclick="toggleSearchType('range')">📊 기간별 조회</button>
                </div>

                <div class="form-grid">
                    <!-- 단일 날짜 조회 -->
                    <div id="singleDateSearch" class="form-group">
                        <label for="viewDate">날짜</label>
                        <input type="date" id="viewDate">
                    </div>
                    
                    <!-- 기간별 조회 -->
                    <div id="rangeDateSearch" class="form-group" style="display: none;">
                        <label>조회 기간</label>
                        <div class="date-range-container">
                            <input type="date" id="startDate" placeholder="시작일">
                            <span>~</span>
                            <input type="date" id="endDate" placeholder="종료일">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="viewGrade">학년</label>
                        <select id="viewGrade">
                            <option value="">전체</option>
                            <option value="1">1학년</option>
                            <option value="2">2학년</option>
                            <option value="3">3학년</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="viewClass">반</label>
                        <select id="viewClass">
                            <option value="">전체</option>
                            <option value="1">1반</option>
                            <option value="2">2반</option>
                            <option value="3">3반</option>
                            <option value="4">4반</option>
                            <option value="5">5반</option>
                            <option value="6">6반</option>
                            <option value="7">7반</option>
                            <option value="8">8반</option>
                            <option value="9">9반</option>
                            <option value="10">10반</option>
                        </select>
                    </div>
                </div>
                <div class="button-group">
                    <button type="button" class="btn-primary" onclick="searchAttendance()">🔍 조회하기</button>
                    <button type="button" class="btn-danger" onclick="deleteAllData()" title="⚠️ 모든 출결 데이터 삭제">🗑️ 전체 삭제</button>
                </div>
                
                <!-- 엑셀 내보내기 옵션 -->
                <div class="export-options" id="exportOptions" style="display: none;">
                    <button type="button" class="btn-success" onclick="exportToExcel()">📊 Excel로 저장</button>
                    <button type="button" class="btn-info" onclick="exportToCSV()">📄 CSV로 저장</button>
                </div>
            </div>

            <div id="attendanceResults"></div>
        </div>
    </div>

    <!-- 삭제 확인 다이얼로그 -->
    <div id="confirmDialog" class="confirm-dialog">
        <div class="confirm-content">
            <h3>⚠️ 삭제 확인</h3>
            <p id="confirmMessage">정말로 이 항목을 삭제하시겠습니까?</p>
            <div class="confirm-buttons">
                <button class="btn-danger" onclick="confirmDelete()">🗑️ 삭제</button>
                <button class="btn-secondary" onclick="cancelDelete()">❌ 취소</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase 설정 (여기에 실제 Firebase 설정값을 넣으세요)
        const firebaseConfig = {
            apiKey: "AIzaSyBAcgyWXmU4uCfFOcXLM_kcihTnay4Uw20",
            authDomain: "dbhs-roll-book.firebaseapp.com",
            databaseURL: "https://dbhs-roll-book-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "dbhs-roll-book",
            storageBucket: "dbhs-roll-book.firebasestorage.app",
            messagingSenderId: "428038181723",
            appId: "1:428038181723:web:79a7f3b94f0edbb70807e",
            measurementId: "G-R4NBV454FN"
        };

        // 담임교사 정보 (실제 동방고등학교 담임교사)
        const homeRoomTeachers = {
            // 1학년
            '1-1': '황인호', '1-2': '원도연', '1-3': '김명수', '1-4': '김석중', '1-5': '이슬',
            '1-6': '이주리', '1-7': '조정기', '1-8': '윤정주', '1-9': '박현주', '1-10': '박소현',
            // 2학년  
            '2-1': '이준호', '2-2': '김승진', '2-3': '김영렬', '2-4': '윤정민', '2-5': '원유숙',
            '2-6': '김소원', '2-7': '강예은', '2-8': '전혜정', '2-9': '한미정', '2-10': '송해린',
            // 3학년
            '3-1': '박상훈', '3-2': '이진우', '3-3': '김중권', '3-4': '정동훈', '3-5': '전진영',
            '3-6': '김현아', '3-7': '이선숙', '3-8': '김수경', '3-9': '강소연', '3-10': '이연지'
        };

        // Firebase 변수들
        let database = null;
        let attendanceRef = null;
        let deleteTarget = null; // 삭제할 대상 저장
        let currentSearchResults = []; // 현재 조회 결과 저장 (엑셀 저장용)
        let currentSearchType = 'single'; // 현재 조회 타입

        // Firebase 초기화 (호환 버전 사용)
        function initializeFirebase() {
            try {
                // Firebase 초기화
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                attendanceRef = database.ref('attendance');
                
                // 연결 상태 표시
                const connectionStatus = document.getElementById('connectionStatus');
                connectionStatus.className = 'status-indicator status-connected';
                
                console.log('Firebase 연결 성공!');
                
                // 초기 데이터 로드
                searchAttendance();
                
            } catch (error) {
                console.error('Firebase 초기화 실패:', error);
                const connectionStatus = document.getElementById('connectionStatus');
                connectionStatus.className = 'status-indicator status-disconnected';
                
                // Firebase 없이도 기본 기능 동작하도록 설정
                console.log('Firebase 연결에 실패했습니다. 데모 모드로 동작합니다.');
            }
        }

        // 페이지 로드 시 초기화
        window.addEventListener('load', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inputDate').value = today;
            document.getElementById('viewDate').value = today;
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            
            // 오늘 날짜 주말 체크
            checkWeekend(document.getElementById('inputDate'));
            
            // Firebase 초기화
            initializeFirebase();
        });

        // 조회 타입 전환
        function toggleSearchType(type) {
            currentSearchType = type;
            const buttons = document.querySelectorAll('.search-type-btn');
            const singleSearch = document.getElementById('singleDateSearch');
            const rangeSearch = document.getElementById('rangeDateSearch');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            
            if (type === 'single') {
                buttons[0].classList.add('active');
                singleSearch.style.display = 'flex';
                rangeSearch.style.display = 'none';
            } else {
                buttons[1].classList.add('active');
                singleSearch.style.display = 'none';
                rangeSearch.style.display = 'flex';
            }
        }

        // 주말 체크 및 날짜 표시 함수
        function checkWeekend(dateInput) {
            const selectedDate = new Date(dateInput.value);
            const dayOfWeek = selectedDate.getDay(); // 0: 일요일, 6: 토요일
            const dateInfo = document.getElementById('dateInfo');
            const weekendWarning = document.getElementById('weekendWarning');
            const submitBtn = document.getElementById('submitBtn');
            
            const dayNames = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
            const dayName = dayNames[dayOfWeek];
            
            // 날짜 정보 표시
            if (dayOfWeek === 0) { // 일요일
                dateInfo.innerHTML = `<span class="sunday">${dayName}</span>`;
                weekendWarning.style.display = 'block';
                submitBtn.disabled = true;
            } else if (dayOfWeek === 6) { // 토요일
                dateInfo.innerHTML = `<span class="saturday">${dayName}</span>`;
                weekendWarning.style.display = 'block';
                submitBtn.disabled = true;
            } else { // 평일
                dateInfo.innerHTML = `<span class="weekday">${dayName}</span>`;
                weekendWarning.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        // 탭 전환
        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tab-content");
            const tabbuttons = document.getElementsByClassName("tab-button");
            
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            
            for (let i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }
            
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
            
            if (tabName === 'view-tab') {
                searchAttendance();
            }
        }

        // 담임교사 자동 입력
        function updateHomeRoomTeacher() {
            const grade = document.getElementById('inputGrade').value;
            const classNum = document.getElementById('inputClass').value;
            const teacherInput = document.getElementById('inputTeacher');
            
            if (grade && classNum) {
                const key = `${grade}-${classNum}`;
                const teacher = homeRoomTeachers[key];
                teacherInput.value = teacher || '';
                teacherInput.style.color = teacher ? '#495057' : '#dc3545';
                if (!teacher) {
                    teacherInput.placeholder = '담임교사 정보가 없습니다';
                }
            } else {
                teacherInput.value = '';
                teacherInput.style.color = '#6c757d';
                teacherInput.placeholder = '학년과 반을 선택하면 자동 입력됩니다';
            }
        }

        // 출석 정보 제출
        async function submitAttendance() {
            const submitBtn = document.getElementById('submitBtn');
            
            // 버튼 비활성화
            submitBtn.disabled = true;
            submitBtn.textContent = '저장 중...';
            
            try {
                const date = document.getElementById('inputDate').value;
                const grade = document.getElementById('inputGrade').value;
                const classNum = document.getElementById('inputClass').value;
                const teacher = document.getElementById('inputTeacher').value;
                const studentId = document.getElementById('studentId').value;
                const studentName = document.getElementById('studentName').value;
                const studentNote = document.getElementById('studentNote').value;

                // 필수 입력 체크
                if (!date || !grade || !classNum || !teacher || !studentId || !studentName) {
                    alert('모든 기본 정보를 입력해주세요.');
                    return;
                }

                // 주말 체크
                const selectedDate = new Date(date);
                const dayOfWeek = selectedDate.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    alert('주말은 등교일이 아닙니다. 평일을 선택해주세요.');
                    return;
                }

                // 출결 상태 확인
                const selectedAttendance = document.querySelector('input[name="attendanceType"]:checked');
                if (!selectedAttendance) {
                    alert('출결 상태를 선택해주세요.');
                    return;
                }

                // 데이터 저장
                const attendanceRecord = {
                    date: date,
                    grade: grade,
                    class: classNum,
                    teacher: teacher,
                    studentId: studentId,
                    studentName: studentName,
                    studentNote: studentNote,
                    attendanceType: selectedAttendance.value,
                    timestamp: new Date().toISOString(),
                    created: Date.now()
                };

                if (database && attendanceRef) {
                    // Firebase에 저장
                    attendanceRef.push(attendanceRecord).then(() => {
                        alert(`${studentName} 학생의 출결 정보가 등록되었습니다.`);
                        clearForm();
                        searchAttendance(); // 자동으로 조회 업데이트
                    }).catch((error) => {
                        console.error('데이터 저장 실패:', error);
                        alert('데이터 저장에 실패했습니다. 다시 시도해주세요.');
                    });
                } else {
                    // 데모 모드
                    console.log('데모 모드 - 저장된 데이터:', attendanceRecord);
                    alert(`${studentName} 학생의 출결 정보가 등록되었습니다. (데모 모드)`);
                    clearForm();
                }
                
            } catch (error) {
                console.error('데이터 저장 실패:', error);
                alert('데이터 저장에 실패했습니다. 다시 시도해주세요.');
            } finally {
                // 버튼 재활성화
                submitBtn.disabled = false;
                submitBtn.textContent = '✅ 입력 완료';
            }
        }

        // 폼 초기화
        function clearForm() {
            document.getElementById('inputGrade').value = '';
            document.getElementById('inputClass').value = '';
            document.getElementById('inputTeacher').value = '';
            document.getElementById('inputTeacher').placeholder = '학년과 반을 선택하면 자동 입력됩니다';
            document.getElementById('studentId').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('studentNote').value = '';
            
            // 라디오 버튼 초기화
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => radio.checked = false);
            
            // 주말 체크 다시 실행
            checkWeekend(document.getElementById('inputDate'));
        }

        // 출석 조회
        async function searchAttendance() {
            const resultsDiv = document.getElementById('attendanceResults');
            
            if (!database || !attendanceRef) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-info">
                        📋 Firebase 연결이 필요합니다. 데모 모드에서는 조회 기능이 제한됩니다.
                    </div>
                `;
                return;
            }

            resultsDiv.innerHTML = '<div class="loading">📊 데이터를 불러오는 중...</div>';

            try {
                let searchDate, startDate, endDate;
                const searchGrade = document.getElementById('viewGrade').value;
                const searchClass = document.getElementById('viewClass').value;

                if (currentSearchType === 'single') {
                    searchDate = document.getElementById('viewDate').value;
                } else {
                    startDate = document.getElementById('startDate').value;
                    endDate = document.getElementById('endDate').value;
                    
                    if (startDate && endDate && startDate > endDate) {
                        alert('시작일이 종료일보다 늦을 수 없습니다.');
                        return;
                    }
                }

                attendanceRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (!data) {
                        resultsDiv.innerHTML = `
                            <div class="alert alert-info">
                                📋 등록된 출결 정보가 없습니다.
                            </div>
                        `;
                        return;
                    }

                    // 데이터를 배열로 변환하고 ID 포함
                    let attendanceArray = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));

                    // 날짜 필터
                    if (currentSearchType === 'single' && searchDate) {
                        attendanceArray = attendanceArray.filter(record => record.date === searchDate);
                    } else if (currentSearchType === 'range' && (startDate || endDate)) {
                        attendanceArray = attendanceArray.filter(record => {
                            const recordDate = record.date;
                            if (startDate && endDate) {
                                return recordDate >= startDate && recordDate <= endDate;
                            } else if (startDate) {
                                return recordDate >= startDate;
                            } else if (endDate) {
                                return recordDate <= endDate;
                            }
                            return true;
                        });
                    }

                    // 학년 필터
                    if (searchGrade) {
                        attendanceArray = attendanceArray.filter(record => record.grade === searchGrade);
                    }

                    // 반 필터
                    if (searchClass) {
                        attendanceArray = attendanceArray.filter(record => record.class === searchClass);
                    }

                    // 최신순 정렬
                    attendanceArray.sort((a, b) => (b.created || 0) - (a.created || 0));

                    displayAttendanceResults(attendanceArray);
                });

            } catch (error) {
                console.error('데이터 조회 실패:', error);
                resultsDiv.innerHTML = `
                    <div class="alert alert-info">
                        ❌ 데이터 조회에 실패했습니다. 다시 시도해주세요.
                    </div>
                `;
            }
        }

        // 출석 결과 표시
        function displayAttendanceResults(data) {
            const resultsDiv = document.getElementById('attendanceResults');
            const exportOptions = document.getElementById('exportOptions');
            
            // 현재 검색 결과 저장 (엑셀 저장용)
            currentSearchResults = data;
            
            if (data.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-info">
                        📋 조회 결과가 없습니다. 검색 조건을 확인해주세요.
                    </div>
                `;
                exportOptions.style.display = 'none';
                return;
            }

            // 엑셀 저장 버튼 표시
            exportOptions.style.display = 'flex';

            const typeClasses = {
                '결석': 'status-absent',
                '지각': 'status-late',
                '조퇴': 'status-early',
                '결과': 'status-absence'
            };

            const detailClasses = {
                '인정': 'detail-approved',
                '미인정': 'detail-unapproved',
                '질병': 'detail-sick'
            };

            let html = `
                <div class="alert alert-success">
                    📊 총 ${data.length}건의 출결 정보가 조회되었습니다.
                </div>
                <div class="attendance-list">
                    <table>
                        <thead>
                            <tr>
                                <th>날짜</th>
                                <th>학년/반</th>
                                <th>담임교사</th>
                                <th>학번</th>
                                <th>학생명</th>
                                <th>비고</th>
                                <th>출결상태</th>
                                <th>등록시간</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach(record => {
                const [type, detail] = record.attendanceType.split('-');
                const typeClass = typeClasses[type] || 'status-absence';
                const detailClass = detailClasses[detail] || 'detail-approved';
                
                html += `
                    <tr>
                        <td>${record.date}</td>
                        <td>${record.grade}학년 ${record.class}반</td>
                        <td>${record.teacher}</td>
                        <td>${record.studentId}</td>
                        <td><strong>${record.studentName}</strong></td>
                        <td>${record.studentNote || '-'}</td>
                        <td>
                            <span class="status-badge ${typeClass}">
                                ${type}
                            </span>
                            <span class="detail-badge ${detailClass}">
                                ${detail}
                            </span>
                        </td>
                        <td>${new Date(record.timestamp || record.created).toLocaleString()}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteRecord('${record.id}', '${record.studentName}')">
                                🗑️ 삭제
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        // 개별 레코드 삭제
        function deleteRecord(recordId, studentName) {
            deleteTarget = { type: 'single', id: recordId, name: studentName };
            document.getElementById('confirmMessage').textContent = `${studentName} 학생의 출결 정보를 삭제하시겠습니까?`;
            document.getElementById('confirmDialog').style.display = 'flex';
        }

        // 전체 데이터 삭제
        function deleteAllData() {
            deleteTarget = { type: 'all' };
            document.getElementById('confirmMessage').textContent = `⚠️ 모든 출결 데이터를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다!`;
            document.getElementById('confirmDialog').style.display = 'flex';
        }

        // 삭제 확인
        async function confirmDelete() {
            if (!deleteTarget) return;

            try {
                if (deleteTarget.type === 'single') {
                    // 개별 삭제
                    const recordRef = attendanceRef.child(deleteTarget.id);
                    await recordRef.remove();
                    alert(`${deleteTarget.name} 학생의 출결 정보가 삭제되었습니다.`);
                } else if (deleteTarget.type === 'all') {
                    // 전체 삭제
                    await attendanceRef.remove();
                    alert('모든 출결 데이터가 삭제되었습니다.');
                }
                
                // 다이얼로그 닫기 및 데이터 새로고침
                cancelDelete();
                searchAttendance();
                
            } catch (error) {
                console.error('삭제 실패:', error);
                alert('삭제에 실패했습니다. 다시 시도해주세요.');
            }
        }

        // 삭제 취소
        function cancelDelete() {
            deleteTarget = null;
            document.getElementById('confirmDialog').style.display = 'none';
        }

        // 다이얼로그 외부 클릭시 닫기
        document.getElementById('confirmDialog').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelDelete();
            }
        });

        // Excel 파일로 내보내기
        function exportToExcel() {
            if (currentSearchResults.length === 0) {
                alert('내보낼 데이터가 없습니다.');
                return;
            }

            // 워크시트 데이터 준비
            const wsData = [
                ['날짜', '학년', '반', '담임교사', '학번', '학생명', '비고', '출결상태', '세부구분', '등록시간'] // 헤더
            ];

            currentSearchResults.forEach(record => {
                const [type, detail] = record.attendanceType.split('-');
                wsData.push([
                    record.date,
                    record.grade + '학년',
                    record.class + '반',
                    record.teacher,
                    record.studentId,
                    record.studentName,
                    record.studentNote || '',
                    type,
                    detail,
                    new Date(record.timestamp || record.created).toLocaleString()
                ]);
            });

            // 엑셀 파일 생성 및 다운로드
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '출석부');

            // 파일명 생성
            const today = new Date().toISOString().split('T')[0];
            const fileName = `동방고등학교_출석부_${today}.xlsx`;

            // 다운로드
            XLSX.writeFile(wb, fileName);
        }

        // CSV 파일로 내보내기
        function exportToCSV() {
            if (currentSearchResults.length === 0) {
                alert('내보낼 데이터가 없습니다.');
                return;
            }

            // CSV 데이터 생성
            let csvContent = '\uFEFF'; // UTF-8 BOM for Korean characters
            csvContent += '날짜,학년,반,담임교사,학번,학생명,비고,출결상태,세부구분,등록시간\n';

            currentSearchResults.forEach(record => {
                const [type, detail] = record.attendanceType.split('-');
                const row = [
                    record.date,
                    record.grade + '학년',
                    record.class + '반',
                    record.teacher,
                    record.studentId,
                    record.studentName,
                    record.studentNote || '',
                    type,
                    detail,
                    new Date(record.timestamp || record.created).toLocaleString()
                ].map(field => `"${field}"`).join(',');
                
                csvContent += row + '\n';
            });

            // 파일 다운로드
            const today = new Date().toISOString().split('T')[0];
            const fileName = `동방고등학교_출석부_${today}.csv`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        }

        // SheetJS 라이브러리 동적 로드
        function loadSheetJS() {
            return new Promise((resolve, reject) => {
                if (window.XLSX) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Excel 내보내기 전에 라이브러리 로드
        const originalExportToExcel = exportToExcel;
        exportToExcel = async function() {
            try {
                await loadSheetJS();
                originalExportToExcel();
            } catch (error) {
                console.error('Excel 라이브러리 로드 실패:', error);
                alert('Excel 파일 생성에 실패했습니다. CSV 파일을 이용해주세요.');
            }
        };
    </script>
</body>
</html>
